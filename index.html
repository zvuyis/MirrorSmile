<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MirrorSmile</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        :root { --accent: #4ebaba; --bg-glass: rgba(15, 20, 25, 0.9); --text-main: #e0e0e0; }
        body { margin: 0; background: #0a0c10; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--text-main); }
        
        .screen { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 200; transition: opacity 0.4s ease; padding: 20px; box-sizing: border-box; }
        canvas { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        video { display: none; }

        .content-card { 
            text-align: center; 
            padding: 30px; 
            max-width: 450px; 
            max-height: 85vh;
            background: var(--bg-glass); 
            border-radius: 30px; 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            overflow-y: auto;
        }
        
        #app-logo { width: 120px; height: 120px; margin-bottom: 20px; border-radius: 50%; border: 1px solid var(--accent); background: #fff; object-fit: contain; padding: 5px; }
        h1 { font-size: 36px; margin: 0 0 20px 0; color: #fff; letter-spacing: 1px; }
        h2 { font-size: 24px; color: var(--accent); margin-bottom: 15px; }
        
        .intro-text { font-size: 16px; line-height: 1.6; margin-bottom: 25px; text-align: right; font-weight: 300; color: #f0f0f0; }
        .intro-text p { margin-bottom: 12px; }

        .instructions-list { text-align: right; margin: 25px 0; padding: 0; list-style: none; }
        .instructions-list li { margin-bottom: 15px; font-size: 17px; display: flex; align-items: flex-start; gap: 10px; }
        .instructions-list li::before { content: "â€¢"; color: var(--accent); font-weight: bold; font-size: 20px; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; width: 100%; align-items: center; }
        .main-btn { width: 100%; max-width: 250px; padding: 14px; border-radius: 30px; background: var(--accent); color: #000; font-size: 17px; font-weight: 600; border: none; cursor: pointer; transition: transform 0.2s; }
        .secondary-btn { width: 100%; max-width: 250px; padding: 12px; border-radius: 30px; background: transparent; color: var(--accent); font-size: 16px; border: 1px solid var(--accent); cursor: pointer; }
        .main-btn:active, .secondary-btn:active { transform: scale(0.97); }

        #ui { position: absolute; bottom: 35px; width: 100%; display: none; flex-direction: column; align-items: center; gap: 15px; z-index: 100; }
        .controls-row { display: flex; gap: 10px; justify-content: center; }
        button.tool-btn { padding: 12px 16px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; backdrop-filter: blur(5px); }
        button.active { background: var(--accent); color: #000; }
        
        #slider-container { width: 80%; max-width: 350px; background: rgba(0,0,0,0.4); padding: 12px 20px; border-radius: 20px; }
        input[type=range] { width: 100%; accent-color: var(--accent); }

        .watermark { position: absolute; bottom: 8px; font-size: 10px; color: rgba(255,255,255,0.25); z-index: 210; width: 100%; text-align: center; pointer-events: none; }
    </style>
</head>
<body>

    <div id="screen-1" class="screen">
        <div class="content-card">
            <img src="logo.png" id="app-logo" alt="MirrorSmile Logo">
            <h1>MirrorSmile</h1>
            <div class="btn-group">
                <button class="main-btn" onclick="showScreen(3)">×œ×”×•×¨××•×ª ×”×©×™××•×©</button>
                <button class="secondary-btn" onclick="showScreen(2)">××•×“×•×ª ×”××¤×œ×™×§×¦×™×”</button>
            </div>
        </div>
    </div>

    <div id="screen-2" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2>××•×“×•×ª MirrorSmile</h2>
            <div class="intro-text">
                <p>MirrorSmile ×”×™× ××¤×œ×™×§×¦×™×™×ª ××™××•×Ÿ ××‘×•×¡×¡×ª ×ª×¨×¤×™×™×ª ××¨××”, ×”××™×•×¢×“×ª ×œ×× ×©×™× ×”××ª××•×“×“×™× ×¢× ×©×™×ª×•×§ ×–×× ×™ ×©×œ ×¢×¦×‘ ×”×¤× ×™× (Bellâ€™s palsy).</p>
                <p>×©×™×ª×•×§ ×¢×¦×‘ ×”×¤× ×™× ×”×•× ×ª×•×¤×¢×” × ×¤×•×¦×”, ×©×œ×¨×•×‘ ×—×•×œ×¤×ª ×¢× ×”×–××Ÿ. ×¢× ×–××ª, ×¢×‘×•×¨ ×¨×‘×™× ×ª×”×œ×™×š ×”×”×—×œ××” ×¢×©×•×™ ×œ×”×™×•×ª ×××•×©×š, ××ª×¡×›×œ ×•×œ×¢×™×ª×™× ××œ×•×•×” ×‘×—×•×¡×¨ ×•×“××•×ª.</p>
                <p>×”××¤×œ×™×§×¦×™×” × ×•×¢×“×” ×œ×œ×•×•×ª ×ª×”×œ×™×š ×©×™×§×•××™ ×¢×“×™×Ÿ, ××•×“×¢ ×•×”×“×¨×’×ª×™, ××ª×•×š ×××•×Ÿ ×‘×™×›×•×œ×ª ×”××•×— ×œ×œ××•×“ ××—×“×© ×•×œ×©×¤×¨ ×ª×¤×§×•×“ ×‘×××¦×¢×•×ª ××™××•×Ÿ ×¢×§×‘×™, ×¡×‘×œ× ×™ ×•××›×•×•×Ÿ.</p>
                <p>MirrorSmile ×¤×•×ª×—×” ×¢×œ-×™×“×™ ×“×§×œ ×¦×™×“×•×Ÿ ×•×™×©×™ ×–×‘×•×œ×•×Ÿ, ×‘××˜×¨×” ×œ×”× ×’×™×© ×ª×¨×¤×™×™×ª ××¨××” ×›×›×œ×™ ××™××•×Ÿ ×“×™×’×™×˜×œ×™ ×¤×©×•×˜, ×–××™×Ÿ ×•×™×“×™×“×•×ª×™ ×œ××©×ª××©.</p>
            </div>
            <button class="main-btn" onclick="showScreen(3)">×œ×”×•×¨××•×ª ×”×©×™××•×©</button>
        </div>
    </div>

    <div id="screen-3" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2>××™×š ×–×” ×¢×•×‘×“?</h2>
            <ul class="instructions-list">
                <li>×¢××“×• ××•×œ ×”××¦×œ××” ×•×”×‘×™×˜×• ×§×“×™××” ×‘×§×• ×™×©×¨.</li>
                <li>×‘×—×¨×• ××ª ×”×¦×“ ×”×‘×¨×™× (×™××™×Ÿ/×©×××œ) ×›×“×™ ×œ×©×§×£ ××•×ª×• ×¢×œ ×”×¦×“ ×”××©×•×ª×§.</li>
                <li>×”×©×ª××©×• ×‘×¡×œ×™×™×“×¨ ×œ×›×™×•×•× ×•×Ÿ ×™×“× ×™ ××“×•×™×§ ×‘××™×“×ª ×”×¦×•×¨×š.</li>
            </ul>
            <button class="main-btn" onclick="startCamera()">×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ</button>
        </div>
    </div>

    <video id="videoElement" playsinline autoplay muted></video>
    <canvas id="mainCanvas"></canvas>
    <canvas id="tempCanvas" style="display:none"></canvas>
    
    <div id="ui">
        <div id="slider-container">
            <input type="range" id="symmetrySlider" min="0" max="100" value="50" oninput="manualAdjust(this.value)">
            <div style="display:flex; justify-content:space-between; font-size:10px; opacity:0.7;">
                <span>××¦×‘ ×™×“× ×™</span>
                <span onclick="resetAuto()" style="cursor:pointer; text-decoration:underline;">×—×–×¨×” ×œ××•×˜×•××˜×™ ğŸ”„</span>
            </div>
        </div>
        <div class="controls-row">
            <button onclick="setMode('none')" id="btnNone" class="tool-btn active">×¨×’×™×œ</button>
            <button onclick="setMode('left')" id="btnLeft" class="tool-btn">×©×××œ</button>
            <button onclick="setMode('right')" id="btnRight" class="tool-btn">×™××™×Ÿ</button>
            <button onclick="toggleGuide()" id="btnGuide" class="tool-btn">ğŸ‘ï¸</button>
            <button onclick="takeSnapshot()" class="tool-btn">ğŸ“¸</button>
        </div>
    </div>

    <div class="watermark">Â© 2026 | MirrorSmile | Developed by Dekel Tzidon & Yishay Zvulun</div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.getElementById('tempCanvas');
        const tCtx = tempCanvas.getContext('2d');
        const slider = document.getElementById('symmetrySlider');

        let currentMode = 'none', smoothNoseX = 0, selfieSegmentation;
        let isManual = false, showGuide = true;

        // ×¤×•× ×§×¦×™×” ×’× ×¨×™×ª ×œ××¢×‘×¨ ×‘×™×Ÿ ××¡×›×™×
        function showScreen(num) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => {
                s.style.opacity = '0';
                setTimeout(() => s.style.display = 'none', 400);
            });
            
            setTimeout(() => {
                const target = document.getElementById('screen-' + num);
                target.style.display = 'flex';
                setTimeout(() => target.style.opacity = '1', 50);
            }, 450);
        }

        async function startCamera() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.style.opacity = '0');
            setTimeout(() => {
                screens.forEach(s => s.style.display = 'none');
                canvas.style.display = 'block';
                document.getElementById('ui').style.display = 'flex';
            }, 450);
            await initModels();
        }

        function manualAdjust(val) { isManual = true; smoothNoseX = (val / 100) * canvas.width; }
        function resetAuto() { isManual = false; }
        function toggleGuide() { showGuide = !showGuide; }

        async function initModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
            selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
            selfieSegmentation.setOptions({ modelSelection: 1 });
            selfieSegmentation.onResults(onResults);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = tempCanvas.width = video.videoWidth;
                canvas.height = tempCanvas.height = video.videoHeight;
                smoothNoseX = canvas.width / 2;
                sendToSegmentation();
            };
        }

        async function sendToSegmentation() {
            if (!video.paused && !video.ended) await selfieSegmentation.send({image: video});
            requestAnimationFrame(sendToSegmentation);
        }

        async function onResults(results) {
            tCtx.save();
            tCtx.clearRect(0, 0, canvas.width, canvas.height);
            tCtx.translate(canvas.width, 0);
            tCtx.scale(-1, 1);
            tCtx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            tCtx.restore();

            if (!isManual) {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                if (detections.length > 0) {
                    const noseX = canvas.width - detections[0].landmarks.getNose()[0].x;
                    smoothNoseX += (noseX - smoothNoseX) * 0.15;
                    slider.value = (smoothNoseX / canvas.width) * 100;
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentMode === 'none') {
                ctx.drawImage(tempCanvas, 0, 0);
            } else if (currentMode === 'left') {
                drawSymmetry(0, smoothNoseX);
            } else if (currentMode === 'right') {
                drawSymmetry(smoothNoseX, canvas.width - smoothNoseX);
            }

            if (showGuide && (isManual || currentMode !== 'none')) {
                ctx.beginPath(); ctx.strokeStyle = 'rgba(78, 186, 186, 0.4)';
                ctx.moveTo(smoothNoseX, 0); ctx.lineTo(smoothNoseX, canvas.height); ctx.stroke();
            }
        }

        function drawSymmetry(sourceX, width) {
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height);
            ctx.save(); ctx.translate(smoothNoseX * 2, 0); ctx.scale(-1, 1);
            ctx.drawImage(tempCanvas, sourceX, 0, width, canvas.height, sourceX, 0, width, canvas.height); ctx.restore();
        }

        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)).classList.add('active');
        }

        function takeSnapshot() {
            const l = document.createElement('a');
            l.download = 'MirrorSmile-Snapshot.png';
            l.href = canvas.toDataURL('image/png');
            l.click();
        }
    </script>
</body>
</html>
